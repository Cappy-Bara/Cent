<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css">
    <title></title>
</head>
<body>

    <p>
        Select lower sound
    </p>

    <div class="settings">

        <div>
            <p>
                Min frequency:
            </p>
            <input type="number"
                   id="minFreq"
                   name="minFreq"
                   value="130.81"
                   onchange="setMinFreq()" />
        </div>


        <div>
            <p>
                Max frequency:
            </p>
            <input type="number"
                   id="maxFreq"
                   name="maxFreq"
                   value="1046.5"
                   onchange="setMaxFreq()" />
        </div>
        <div>
            <p>
                Difficulity (in cents):
            </p>
            <input type="number"
                   id="difficulity"
                   name="difficulity"
                   value="10"
                   onchange="setDifficulity()" />
        </div>
    </div>

    <div class="stats">
        <span>Questions: <strong id="questionCount">0</strong></span>
        <span>Correct: <strong id="correctCount">0</strong></span>
    </div>

    <div class="game">

        <div>
            <button class="control"
                    onclick="checkAnswer(1)">
                First is lower
            </button>

            <button class="control"
                    onclick="playSound(first,500)">
                <img src="sound.svg" alt="PlayFirst" width="80" height="80">
            </button>
        </div>

        <div>
            <button class="control"
                    onclick="checkAnswer(2)">
                Second is lower
            </button>

            <button class="control"
                    onclick="playSound(second,500)">
                <img src="sound.svg" alt="PlaySecond" width="80" height="80">
            </button>
        </div>
    </div>

    <div class="results">
        <p id="message"></p>
    </div>

    <button id="nextButton"
            onclick="nextQuestion()">
        Next Question
    </button>

    <div class="keyboard-legend">
        <div class="legend-title">Keyboard shortcuts</div>
        <span><kbd>1</kbd> First is lower</span>
        <span><kbd>2</kbd> Second is lower</span>
        <span><kbd>4</kbd> Play first sound</span>
        <span><kbd>5</kbd> Play second sound</span>
        <span><kbd>3</kbd> Next question</span>
    </div>

    <script src="https://unpkg.com/tone"></script>
    <script src="sounds.js"></script>

    <script>
        let minFrequency, maxFrequency, difficulity;

        setMinFreq();
        setMaxFreq();
        setDifficulity();

        let success = null;
        let isResponded = false;
        let first;
        let second;
        let isFirstHiger = false;
        let questionCount = 0;
        let correctCount = 0;

        addKeyboardControl();
        nextQuestion();

        function addKeyboardControl() {
            window.addEventListener('keydown', ev => {
                if (ev.key === "4") {
                    playSound(first, 500);
                }
                if (ev.key === "5") {
                    playSound(second, 500);
                }
                if (ev.key === "1") {
                    checkAnswer(1);
                }
                if (ev.key === "2") {
                    checkAnswer(2);
                }
                if (ev.key === "3" && isResponded) {
                    nextQuestion();
                }
            })
        }

        function checkAnswer(selectedTone) {
            if ((isFirstHiger && selectedTone === 2) ||
                (!isFirstHiger && selectedTone === 1)) {
                correctCount++;
                showSuccess();
                showElement("nextButton");
                success = true;
                isResponded = true;
            } else {
                showWrong();
                showElement("nextButton");
                success = false;
                isResponded = true;
            }
        }

        function hideElement(element) {
            document.getElementById(element).style.visibility = "hidden";;
        }

        function showElement(element) {
            document.getElementById(element).style.visibility = "visible";;
        }

        function nextQuestion() {
            questionCount++;
            var lowerSound = (Math.random() * (maxFrequency - minFrequency)) + minFrequency;
            var upperSound = getDetunedUpperSoundFrequency(lowerSound, difficulity);

            isFirstHiger = Math.random() < 0.5;

            first = isFirstHiger ? upperSound : lowerSound;
            second = isFirstHiger ? lowerSound : upperSound;

            playSounds();

            hideMessage()
            hideElement("nextButton");
            isResponded = false;
            updateStats();
        }

        function setDifficulity() {
            difficulity = parseInt(document.getElementById("difficulity").value);
        }

        function setMinFreq() {
            minFrequency = parseFloat(document.getElementById("minFreq").value);
        }

        function setMaxFreq() {
            maxFrequency = parseFloat(document.getElementById("maxFreq").value);
        }

        function playSounds() {
            playSound(first, 500);
            setTimeout(() => {
                playSound(second, 500);
            }, 1000);
        }

        function showSuccess() {
            const m = document.getElementById("message");
            m.textContent = "Success!";
            m.style.color = "green";
            m.style.visibility = "visible";
        }

        function showWrong() {
            const m = document.getElementById("message");
            m.textContent = "Wrong!";
            m.style.color = "red";
            m.style.visibility = "visible";
        }

        function hideMessage() {
            document.getElementById("message").style.visibility = "hidden";
        }

        function updateStats() {
            document.getElementById("questionCount").textContent = questionCount;
            document.getElementById("correctCount").textContent = correctCount;
        }

    </script>


</body>

</html>